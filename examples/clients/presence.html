<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verani Presence Example</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">üë• Presence Tracking</h1>
          <p class="text-sm text-gray-600">See who's online in real-time</p>
        </div>
        <div class="flex items-center space-x-4">
          <span id="status" class="text-sm px-3 py-1 rounded-full bg-gray-200">Disconnected</span>
          <button onclick="window.location.href='/'" class="text-blue-500 hover:underline">‚Üê Back</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 max-w-6xl w-full mx-auto p-4">
      <!-- Stats -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
          <div class="text-3xl font-bold text-blue-600" id="totalUsers">0</div>
          <div class="text-sm text-gray-600">Total Users</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
          <div class="text-3xl font-bold text-green-600" id="totalConnections">0</div>
          <div class="text-sm text-gray-600">Total Connections</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
          <div class="text-3xl font-bold text-purple-600" id="yourDevices">0</div>
          <div class="text-sm text-gray-600">Your Devices</div>
        </div>
      </div>

      <!-- User Grid -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">Online Users</h2>
        <div id="userGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Users will be added here -->
        </div>
        <div id="emptyState" class="text-center text-gray-500 py-8">
          No users online
        </div>
      </div>
    </main>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-4">Join Presence</h2>
      <p class="text-gray-600 mb-4">Enter a username to track presence</p>
      <input 
        type="text" 
        id="usernameInput" 
        placeholder="user:yourname"
        class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-green-500"
      />
      <button 
        onclick="connect()" 
        class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"
      >
        Connect
      </button>
      <p class="text-sm text-gray-500 mt-4">
        Format: <code class="bg-gray-100 px-2 py-1 rounded">user:yourname</code><br>
        Open multiple tabs to see multi-device tracking!
      </p>
    </div>
  </div>

  <script type="module">
    let ws = null;
    let username = "";
    let userId = "";
    const users = new Map();

    // Connect to presence room
    window.connect = function() {
      const input = document.getElementById("usernameInput");
      const token = input.value.trim();
      
      if (!token) {
        alert("Please enter a username");
        return;
      }

      username = token.split(":")[1] || token;
      userId = username;
      
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${protocol}//${window.location.host}/ws/presence?token=${encodeURIComponent(token)}`;
      
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log("Connected!");
        updateStatus("connected");
        document.getElementById("loginModal").style.display = "none";
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };

      ws.onclose = () => {
        console.log("Disconnected");
        updateStatus("disconnected");
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        updateStatus("error");
      };
    };

    // Handle incoming messages
    function handleMessage(msg) {
      switch (msg.type) {
        case "presence.sync":
          users.clear();
          msg.data.users.forEach(user => {
            users.set(user.userId, user);
          });
          updateStats(msg.data);
          renderUsers();
          break;
        
        case "presence.online":
          users.set(msg.userId, {
            userId: msg.userId,
            username: msg.username,
            status: msg.status,
            devices: msg.devices
          });
          showNotification(`${msg.username} is now online`, "success");
          renderUsers();
          break;
        
        case "presence.offline":
          users.delete(msg.userId);
          showNotification(`${msg.username} went offline`, "info");
          renderUsers();
          break;
        
        case "presence.update":
          const user = users.get(msg.userId);
          if (user) {
            user.devices = msg.devices;
            renderUsers();
          }
          break;
        
        case "presence.status":
          const statusUser = users.get(msg.userId);
          if (statusUser) {
            statusUser.status = msg.status;
            renderUsers();
          }
          break;
      }
    }

    // Update stats
    function updateStats(data) {
      document.getElementById("totalUsers").textContent = data.totalUsers;
      document.getElementById("totalConnections").textContent = data.totalConnections;
      
      const myUser = users.get(userId);
      document.getElementById("yourDevices").textContent = myUser ? myUser.devices : 0;
    }

    // Render users grid
    function renderUsers() {
      const grid = document.getElementById("userGrid");
      const empty = document.getElementById("emptyState");
      
      if (users.size === 0) {
        grid.style.display = "none";
        empty.style.display = "block";
        return;
      }

      grid.style.display = "grid";
      empty.style.display = "none";

      grid.innerHTML = Array.from(users.values()).map(user => {
        const isMe = user.userId === userId;
        const statusColors = {
          online: "bg-green-100 text-green-800",
          away: "bg-yellow-100 text-yellow-800",
          busy: "bg-red-100 text-red-800"
        };

        return `
          <div class="border rounded-lg p-4 ${isMe ? "border-blue-500 bg-blue-50" : ""}">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full ${user.status === "online" ? "bg-green-500" : user.status === "away" ? "bg-yellow-500" : "bg-red-500"}"></div>
                <span class="font-semibold">${user.username}</span>
                ${isMe ? '<span class="text-xs text-blue-600">(You)</span>' : ""}
              </div>
              <span class="text-xs px-2 py-1 rounded-full ${statusColors[user.status]}">${user.status}</span>
            </div>
            <div class="text-sm text-gray-600">
              ${user.devices} device${user.devices !== 1 ? "s" : ""}
            </div>
          </div>
        `;
      }).join("");
    }

    // UI Helper Functions
    function updateStatus(status) {
      const statusEl = document.getElementById("status");
      const statusMap = {
        connected: { text: "Connected", class: "bg-green-200 text-green-800" },
        disconnected: { text: "Disconnected", class: "bg-gray-200 text-gray-800" },
        error: { text: "Error", class: "bg-red-200 text-red-800" }
      };
      const config = statusMap[status] || statusMap.disconnected;
      statusEl.textContent = config.text;
      statusEl.className = `text-sm px-3 py-1 rounded-full ${config.class}`;
    }

    function showNotification(message, type) {
      const notification = document.createElement("div");
      notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg transition-opacity ${
        type === "success" ? "bg-green-500" : "bg-blue-500"
      } text-white`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = "0";
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>

