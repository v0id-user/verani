<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verani Chat Example</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">üí¨ Chat Room</h1>
          <p class="text-sm text-gray-600">Real-time messaging example</p>
        </div>
        <div class="flex items-center space-x-4">
          <span id="status" class="text-sm px-3 py-1 rounded-full bg-gray-200">Disconnected</span>
          <button onclick="window.location.href='/'" class="text-blue-500 hover:underline">‚Üê Back</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 max-w-4xl w-full mx-auto p-4 flex gap-4">
      <!-- Messages Area -->
      <div class="flex-1 flex flex-col bg-white rounded-lg shadow">
        <!-- Online Users -->
        <div class="border-b p-4">
          <div class="flex items-center justify-between">
            <span class="font-semibold">Online Users</span>
            <span id="userCount" class="text-sm text-gray-500">0 online</span>
          </div>
          <div id="onlineUsers" class="flex flex-wrap gap-2 mt-2"></div>
        </div>

        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="px-4 py-2 text-sm text-gray-500 italic min-h-[2rem]"></div>

        <!-- Input -->
        <div class="border-t p-4">
          <div class="flex gap-2">
            <input 
              type="text" 
              id="messageInput" 
              placeholder="Type a message..."
              class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled
            />
            <button 
              id="sendButton"
              onclick="sendMessage()" 
              class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-4">Join Chat</h2>
      <p class="text-gray-600 mb-4">Enter a username to start chatting</p>
      <input 
        type="text" 
        id="usernameInput" 
        placeholder="user:yourname"
        class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button 
        onclick="connect()" 
        class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
      >
        Connect
      </button>
      <p class="text-sm text-gray-500 mt-4">
        Format: <code class="bg-gray-100 px-2 py-1 rounded">user:yourname</code><br>
        Open multiple tabs to see real-time sync!
      </p>
    </div>
  </div>

  <script type="module">
    let ws = null;
    let username = "";
    let typingTimeout = null;
    const typingUsers = new Set();

    // Connect to chat room
    window.connect = function() {
      const input = document.getElementById("usernameInput");
      const token = input.value.trim();
      
      if (!token) {
        alert("Please enter a username");
        return;
      }

      // Extract username from token
      username = token.split(":")[1] || token;
      
      // Build WebSocket URL
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${protocol}//${window.location.host}/chat?token=${encodeURIComponent(token)}`;
      
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log("Connected!");
        updateStatus("connected");
        document.getElementById("loginModal").style.display = "none";
        document.getElementById("messageInput").disabled = false;
        document.getElementById("sendButton").disabled = false;
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };

      ws.onclose = () => {
        console.log("Disconnected");
        updateStatus("disconnected");
        document.getElementById("messageInput").disabled = true;
        document.getElementById("sendButton").disabled = true;
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        updateStatus("error");
      };
    };

    // Handle incoming messages
    function handleMessage(msg) {
      switch (msg.type) {
        case "users.sync":
          updateOnlineUsers(msg.data.users);
          break;
        
        case "user.joined":
          addSystemMessage(`${msg.username} joined the chat`);
          break;
        
        case "user.left":
          addSystemMessage(`${msg.username} left the chat`);
          typingUsers.delete(msg.username);
          updateTypingIndicator();
          break;
        
        case "chat.message":
          addMessage(msg.username, msg.text, msg.timestamp);
          typingUsers.delete(msg.username);
          updateTypingIndicator();
          break;
        
        case "chat.typing":
          typingUsers.add(msg.username);
          updateTypingIndicator();
          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
            typingUsers.delete(msg.username);
            updateTypingIndicator();
          }, 3000);
          break;
        
        case "system.message":
          addSystemMessage(msg.data.text);
          break;
      }
    }

    // Send message
    window.sendMessage = function() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      
      if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

      ws.send(JSON.stringify({
        type: "chat.message",
        data: { text }
      }));

      input.value = "";
    };

    // Send typing indicator
    document.getElementById("messageInput")?.addEventListener("input", () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "chat.typing", data: {} }));
      }
    });

    // Send on Enter key
    document.getElementById("messageInput")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // UI Helper Functions
    function updateStatus(status) {
      const statusEl = document.getElementById("status");
      const statusMap = {
        connected: { text: "Connected", class: "bg-green-200 text-green-800" },
        disconnected: { text: "Disconnected", class: "bg-gray-200 text-gray-800" },
        error: { text: "Error", class: "bg-red-200 text-red-800" }
      };
      const config = statusMap[status] || statusMap.disconnected;
      statusEl.textContent = config.text;
      statusEl.className = `text-sm px-3 py-1 rounded-full ${config.class}`;
    }

    function updateOnlineUsers(users) {
      const container = document.getElementById("onlineUsers");
      const count = document.getElementById("userCount");
      
      count.textContent = `${users.length} online`;
      
      container.innerHTML = users.map(userId => 
        `<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${userId}</span>`
      ).join("");
    }

    function addMessage(from, text, timestamp) {
      const messages = document.getElementById("messages");
      const isOwn = from === username;
      
      const div = document.createElement("div");
      div.className = `flex ${isOwn ? "justify-end" : "justify-start"}`;
      div.innerHTML = `
        <div class="max-w-xs ${isOwn ? "bg-blue-500 text-white" : "bg-gray-200"} rounded-lg px-4 py-2">
          ${!isOwn ? `<div class="font-semibold text-sm mb-1">${from}</div>` : ""}
          <div>${escapeHtml(text)}</div>
          <div class="text-xs opacity-70 mt-1">${formatTime(timestamp)}</div>
        </div>
      `;
      
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function addSystemMessage(text) {
      const messages = document.getElementById("messages");
      const div = document.createElement("div");
      div.className = "text-center";
      div.innerHTML = `<span class="text-sm text-gray-500 italic">${text}</span>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function updateTypingIndicator() {
      const indicator = document.getElementById("typingIndicator");
      if (typingUsers.size === 0) {
        indicator.textContent = "";
      } else {
        const users = Array.from(typingUsers).join(", ");
        indicator.textContent = `${users} ${typingUsers.size === 1 ? "is" : "are"} typing...`;
      }
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>

