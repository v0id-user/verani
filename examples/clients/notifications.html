<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verani Notifications Example</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">üîî Notifications Feed</h1>
          <p class="text-sm text-gray-600">Personal notification stream</p>
        </div>
        <div class="flex items-center space-x-4">
          <span id="deviceCount" class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded">0 devices</span>
          <span id="status" class="text-sm px-3 py-1 rounded-full bg-gray-200">Disconnected</span>
          <button onclick="window.location.href='/'" class="text-blue-500 hover:underline">‚Üê Back</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 max-w-4xl w-full mx-auto p-4">
      <!-- Actions -->
      <div class="mb-4 flex justify-between items-center">
        <button 
          onclick="markAllRead()" 
          class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600"
        >
          Mark All Read
        </button>
        <button 
          onclick="simulateNotification()" 
          class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
        >
          Simulate Notification
        </button>
      </div>

      <!-- Notifications List -->
      <div id="notificationsList" class="space-y-3">
        <!-- Notifications will be added here -->
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
        <div class="text-6xl mb-4">üì≠</div>
        <p>No notifications yet</p>
        <p class="text-sm mt-2">Click "Simulate Notification" to test</p>
      </div>
    </main>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-4">Access Notifications</h2>
      <p class="text-gray-600 mb-4">Enter your username to view your personal feed</p>
      <input 
        type="text" 
        id="usernameInput" 
        placeholder="user:yourname"
        class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
      <button 
        onclick="connect()" 
        class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600"
      >
        Connect
      </button>
      <p class="text-sm text-gray-500 mt-4">
        Format: <code class="bg-gray-100 px-2 py-1 rounded">user:yourname</code><br>
        Open multiple tabs to see sync across devices!
      </p>
    </div>
  </div>

  <script type="module">
    let ws = null;
    let username = "";
    let userId = "";
    const notifications = new Map();
    let notificationIdCounter = 0;

    // Connect to notifications room
    window.connect = function() {
      const input = document.getElementById("usernameInput");
      const token = input.value.trim();
      
      if (!token) {
        alert("Please enter a username");
        return;
      }

      username = token.split(":")[1] || token;
      userId = username;
      
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${protocol}//${window.location.host}/notifications?token=${encodeURIComponent(token)}&userId=${encodeURIComponent(userId)}`;
      
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log("Connected!");
        updateStatus("connected");
        document.getElementById("loginModal").style.display = "none";
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };

      ws.onclose = () => {
        console.log("Disconnected");
        updateStatus("disconnected");
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        updateStatus("error");
      };
    };

    // Handle incoming messages
    function handleMessage(msg) {
      switch (msg.type) {
        case "notifications.sync":
          msg.data.notifications.forEach(notif => {
            notifications.set(notif.id, notif);
          });
          renderNotifications();
          break;
        
        case "notification.new":
          notifications.set(msg.data.id, msg.data);
          renderNotifications();
          showToast(msg.data);
          playSound();
          break;
        
        case "notification.read":
          const notif = notifications.get(msg.notificationId);
          if (notif) {
            notif.read = true;
            renderNotifications();
          }
          break;
        
        case "notification.readAll":
          notifications.forEach(n => n.read = true);
          renderNotifications();
          break;
        
        case "notification.deleted":
          notifications.delete(msg.notificationId);
          renderNotifications();
          break;
        
        case "device.connected":
        case "device.disconnected":
          updateDeviceCount(msg.deviceCount);
          break;
      }
    }

    // Mark notification as read
    function markRead(notificationId) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: "notification.read",
          data: { notificationId }
        }));
      }
    }

    // Mark all as read
    window.markAllRead = function() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: "notification.readAll",
          data: {}
        }));
      }
    };

    // Delete notification
    function deleteNotification(notificationId) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: "notification.delete",
          data: { notificationId }
        }));
      }
    }

    // Simulate a new notification
    window.simulateNotification = function() {
      const types = ["info", "success", "warning", "error"];
      const titles = ["New Message", "Update Available", "Warning", "Error Occurred"];
      const messages = [
        "You have a new message",
        "Version 2.0 is available",
        "Your session will expire soon",
        "Failed to save changes"
      ];
      
      const index = Math.floor(Math.random() * types.length);
      const notification = {
        id: `notif-${notificationIdCounter++}`,
        type: types[index],
        title: titles[index],
        message: messages[index],
        timestamp: Date.now(),
        read: false
      };

      notifications.set(notification.id, notification);
      renderNotifications();
      showToast(notification);
      playSound();
    };

    // Render notifications
    function renderNotifications() {
      const list = document.getElementById("notificationsList");
      const empty = document.getElementById("emptyState");
      
      if (notifications.size === 0) {
        list.style.display = "none";
        empty.style.display = "block";
        return;
      }

      list.style.display = "block";
      empty.style.display = "none";

      const sorted = Array.from(notifications.values()).sort((a, b) => b.timestamp - a.timestamp);

      list.innerHTML = sorted.map(notif => {
        const typeColors = {
          info: "bg-blue-50 border-blue-200",
          success: "bg-green-50 border-green-200",
          warning: "bg-yellow-50 border-yellow-200",
          error: "bg-red-50 border-red-200"
        };

        const iconColors = {
          info: "text-blue-500",
          success: "text-green-500",
          warning: "text-yellow-500",
          error: "text-red-500"
        };

        const icons = {
          info: "‚ÑπÔ∏è",
          success: "‚úÖ",
          warning: "‚ö†Ô∏è",
          error: "‚ùå"
        };

        return `
          <div class="bg-white border rounded-lg p-4 shadow ${typeColors[notif.type]} ${notif.read ? "opacity-60" : ""}">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-2xl">${icons[notif.type]}</span>
                  <span class="font-semibold">${notif.title}</span>
                  ${!notif.read ? '<span class="w-2 h-2 bg-purple-500 rounded-full"></span>' : ""}
                </div>
                <p class="text-gray-700 mb-2">${notif.message}</p>
                <p class="text-xs text-gray-500">${formatTime(notif.timestamp)}</p>
              </div>
              <div class="flex space-x-2 ml-4">
                ${!notif.read ? `<button onclick="markRead('${notif.id}')" class="text-purple-500 hover:text-purple-700 text-sm">Mark Read</button>` : ""}
                <button onclick="deleteNotification('${notif.id}')" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    // Update device count
    function updateDeviceCount(count) {
      document.getElementById("deviceCount").textContent = `${count} device${count !== 1 ? "s" : ""}`;
    }

    // Show toast notification
    function showToast(notification) {
      const toast = document.createElement("div");
      toast.className = "fixed top-20 right-4 bg-white border-l-4 border-purple-500 shadow-lg rounded-lg p-4 max-w-md animate-slide-in";
      toast.innerHTML = `
        <div class="font-semibold mb-1">${notification.title}</div>
        <div class="text-sm text-gray-600">${notification.message}</div>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Play notification sound (simple beep)
    function playSound() {
      const audio = new AudioContext();
      const oscillator = audio.createOscillator();
      const gain = audio.createGain();
      
      oscillator.connect(gain);
      gain.connect(audio.destination);
      
      oscillator.frequency.value = 800;
      gain.gain.value = 0.1;
      
      oscillator.start();
      setTimeout(() => oscillator.stop(), 100);
    }

    // UI Helper Functions
    function updateStatus(status) {
      const statusEl = document.getElementById("status");
      const statusMap = {
        connected: { text: "Connected", class: "bg-green-200 text-green-800" },
        disconnected: { text: "Disconnected", class: "bg-gray-200 text-gray-800" },
        error: { text: "Error", class: "bg-red-200 text-red-800" }
      };
      const config = statusMap[status] || statusMap.disconnected;
      statusEl.textContent = config.text;
      statusEl.className = `text-sm px-3 py-1 rounded-full ${config.class}`;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return "Just now";
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return date.toLocaleDateString();
    }
  </script>
</body>
</html>

